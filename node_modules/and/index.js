var http = require('http');
var Engine = require('engine.io-stream');
var crdt = require('crdt');
var ecstatic = require('ecstatic');
var stay = require('level-stay');

module.exports = And;

function And(db) {
  if (!(this instanceof And)) return new And(db);

  this.doc = new crdt.Doc();
  this.db = db;
  stay(this.db, 'doc', this.doc);
}

And.prototype.createStream = function() {
  return this.doc.createStream();
};

And.prototype.createServer = function() {
  var self = this;
  var server = http.createServer(ecstatic(__dirname + '/static'));

  var engine = Engine(function(con) {
    con.pipe(self.createStream()).pipe(con);
  });
  engine.attach(server, '/doc');

  return server;
};

